═══════════════════════════════════════════════════════════════════════════════════
                        CROPIO PLATFORM - DATABASE SCHEMA
                   Security-First File Processing with Real-Time Analytics
═══════════════════════════════════════════════════════════════════════════════════

┌─ USER MANAGEMENT TABLES ─────────────────────────────────────────────────────────┐
│                                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐                                     │
│  │     users       │────│  user_sessions  │                                     │
│  ├─────────────────┤    ├─────────────────┤                                     │
│  │ id (PK)         │    │ id (PK)         │                                     │
│  │ username (UK)   │    │ user_id (FK)    │                                     │
│  │ email (UK)      │    │ session_token   │                                     │
│  │ password_hash   │    │ ip_address      │                                     │
│  │ first_name      │    │ user_agent      │                                     │
│  │ last_name       │    │ created_at      │                                     │
│  │ role            │    │ expires_at      │                                     │
│  │ is_active       │    │ is_active       │                                     │
│  │ email_verified  │    └─────────────────┘                                     │
│  │ created_at      │                                                            │
│  │ updated_at      │                                                            │
│  │ last_login      │                                                            │
│  │ login_attempts  │                                                            │
│  │ locked_until    │                                                            │
│  └─────────────────┘                                                            │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

┌─ FILE PROCESSING TABLES ─────────────────────────────────────────────────────────┐
│                                                                                   │
│  ┌─────────────────────┐    ┌─────────────────────┐                             │
│  │  file_operations    │────│   file_metadata     │                             │
│  ├─────────────────────┤    ├─────────────────────┤                             │
│  │ id (PK)             │    │ id (PK)             │                             │
│  │ user_id (FK)        │    │ file_operation_id   │                             │
│  │ session_id          │    │ file_hash (UK)      │                             │
│  │ operation_type      │    │ mime_type           │                             │
│  │ operation_subtype   │    │ actual_mime_type    │                             │
│  │ status              │    │ file_extension      │                             │
│  │ input_file_path     │    │ file_size_bytes     │                             │
│  │ output_file_path    │    │ is_suspicious       │                             │
│  │ original_filename   │    │ malware_scan_result │                             │
│  │ processed_filename  │    │ malware_scanner     │                             │
│  │ file_size_bytes     │    │ scan_timestamp      │                             │
│  │ processed_file_size │    │ exif_data (JSONB)   │                             │
│  │ processing_time_ms  │    │ pdf_metadata (JSONB)│                             │
│  │ error_message       │    │ document_properties │                             │
│  │ metadata (JSONB)    │    │ created_at          │                             │
│  │ created_at          │    └─────────────────────┘                             │
│  │ completed_at        │                                                        │
│  │ expires_at          │                                                        │
│  └─────────────────────┘                                                        │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

┌─ SECURITY & MONITORING TABLES ───────────────────────────────────────────────────┐
│                                                                                   │
│  ┌─────────────────────┐                                                         │
│  │  sec_request_log    │                                                         │
│  ├─────────────────────┤                                                         │
│  │ id (PK)             │                                                         │
│  │ user_id (FK)        │                                                         │
│  │ session_id          │                                                         │
│  │ ip_address          │                                                         │
│  │ user_agent          │                                                         │
│  │ request_method      │                                                         │
│  │ request_path        │                                                         │
│  │ request_size_bytes  │                                                         │
│  │ response_status     │                                                         │
│  │ response_time_ms    │                                                         │
│  │ country_code        │                                                         │
│  │ region              │                                                         │
│  │ city                │                                                         │
│  │ is_suspicious       │                                                         │
│  │ risk_score (0-100)  │                                                         │
│  │ threat_indicators   │                                                         │
│  │ created_at          │                                                         │
│  └─────────────────────┘                                                         │
│                                                                                   │
│  ┌─────────────────────┐    ┌─────────────────────┐                             │
│  │   sec_blocklist     │    │   sec_incidents     │                             │
│  ├─────────────────────┤    ├─────────────────────┤                             │
│  │ id (PK)             │    │ id (PK)             │                             │
│  │ ip_address          │    │ incident_type       │                             │
│  │ ip_range (CIDR)     │    │ severity            │                             │
│  │ block_type          │    │ title               │                             │
│  │ blocked_by_user_id  │    │ description         │                             │
│  │ reason              │    │ affected_user_id    │                             │
│  │ severity            │    │ affected_ip         │                             │
│  │ is_active           │    │ source_data (JSONB) │                             │
│  │ expires_at          │    │ status              │                             │
│  │ created_at          │    │ assigned_to_user_id │                             │
│  │ updated_at          │    │ resolution_notes    │                             │
│  └─────────────────────┘    │ created_at          │                             │
│                             │ resolved_at         │                             │
│                             └─────────────────────┘                             │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

┌─ SYSTEM CONFIGURATION TABLES ────────────────────────────────────────────────────┐
│                                                                                   │
│  ┌─────────────────────┐    ┌─────────────────────┐                             │
│  │   app_settings      │    │   feature_flags     │                             │
│  ├─────────────────────┤    ├─────────────────────┤                             │
│  │ id (PK)             │    │ id (PK)             │                             │
│  │ setting_key (UK)    │    │ flag_name (UK)      │                             │
│  │ setting_value       │    │ is_enabled          │                             │
│  │ setting_type        │    │ rollout_percentage  │                             │
│  │ description         │    │ target_users (JSONB)│                             │
│  │ is_public           │    │ description         │                             │
│  │ created_at          │    │ created_at          │                             │
│  │ updated_at          │    │ updated_at          │                             │
│  │ updated_by_user_id  │    └─────────────────────┘                             │
│  └─────────────────────┘                                                        │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

┌─ ANALYTICS & REPORTING TABLES ───────────────────────────────────────────────────┐
│                                                                                   │
│  ┌─────────────────────┐                                                         │
│  │  usage_analytics    │                                                         │
│  ├─────────────────────┤                                                         │
│  │ id (PK)             │                                                         │
│  │ event_type          │                                                         │
│  │ user_id (FK)        │                                                         │
│  │ session_id          │                                                         │
│  │ ip_address          │                                                         │
│  │ user_agent          │                                                         │
│  │ page_path           │                                                         │
│  │ referrer            │                                                         │
│  │ event_data (JSONB)  │                                                         │
│  │ created_at          │                                                         │
│  └─────────────────────┘                                                         │
│                                                                                   │
│  ┌─────────────────────┐    ┌─────────────────────┐                             │
│  │    daily_stats      │    │     audit_log       │                             │
│  ├─────────────────────┤    ├─────────────────────┤                             │
│  │ id (PK)             │    │ id (PK)             │                             │
│  │ date (UK)           │    │ user_id (FK)        │                             │
│  │ total_users         │    │ action              │                             │
│  │ new_users           │    │ resource_type       │                             │
│  │ total_files_processed│   │ resource_id         │                             │
│  │ total_data_bytes    │    │ old_values (JSONB)  │                             │
│  │ successful_ops      │    │ new_values (JSONB)  │                             │
│  │ failed_operations   │    │ ip_address          │                             │
│  │ security_incidents  │    │ user_agent          │                             │
│  │ blocked_requests    │    │ success             │                             │
│  │ unique_ips          │    │ error_message       │                             │
│  │ created_at          │    │ created_at          │                             │
│  └─────────────────────┘    └─────────────────────┘                             │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════
                              RELATIONSHIP OVERVIEW
═══════════════════════════════════════════════════════════════════════════════════

┌─ PRIMARY RELATIONSHIPS ──────────────────────────────────────────────────────────┐
│                                                                                   │
│  users (1) ────────── (N) user_sessions                                          │
│    │                                                                             │
│    ├───────────────── (N) file_operations                                       │
│    │                         │                                                   │
│    │                         └──── (1) file_metadata                            │
│    │                                                                             │
│    ├───────────────── (N) sec_request_log                                       │
│    │                                                                             │
│    ├───────────────── (N) sec_blocklist (as blocker)                           │
│    │                                                                             │
│    ├───────────────── (N) sec_incidents (as affected_user)                     │
│    │                                                                             │
│    ├───────────────── (N) sec_incidents (as assigned_admin)                    │
│    │                                                                             │
│    ├───────────────── (N) app_settings (as updater)                            │
│    │                                                                             │
│    ├───────────────── (N) usage_analytics                                       │
│    │                                                                             │
│    └───────────────── (N) audit_log                                             │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════
                                KEY CONSTRAINTS
═══════════════════════════════════════════════════════════════════════════════════

┌─ CHECK CONSTRAINTS ──────────────────────────────────────────────────────────────┐
│                                                                                   │
│  • users.role IN ('admin', 'user', 'moderator')                                 │
│                                                                                   │
│  • file_operations.status IN ('pending', 'processing', 'completed',             │
│                               'failed', 'quarantined')                          │
│                                                                                   │
│  • file_metadata.malware_scan_result IN ('clean', 'infected',                   │
│                                          'suspicious', 'pending')               │
│                                                                                   │
│  • sec_request_log.risk_score >= 0 AND risk_score <= 100                       │
│                                                                                   │
│  • sec_blocklist.block_type IN ('manual', 'auto', 'geo', 'reputation')         │
│  • sec_blocklist.severity IN ('low', 'medium', 'high', 'critical')             │
│                                                                                   │
│  • sec_incidents.severity IN ('low', 'medium', 'high', 'critical')             │
│  • sec_incidents.status IN ('open', 'investigating', 'resolved',               │
│                             'false_positive')                                   │
│                                                                                   │
│  • app_settings.setting_type IN ('string', 'integer', 'boolean', 'json')       │
│                                                                                   │
│  • feature_flags.rollout_percentage >= 0 AND rollout_percentage <= 100         │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

┌─ BUSINESS RULES ─────────────────────────────────────────────────────────────────┐
│                                                                                   │
│  • Either user_id OR session_id must be present in file_operations              │
│  • Either ip_address OR ip_range must be present in sec_blocklist               │
│  • file_metadata.file_hash must be uppercase SHA-256 format                     │
│  • Auto-cleanup of expired file_operations based on expires_at                  │
│  • Session management with automatic expiration                                  │
│  • Geographic data collection for security analysis                              │
│  • Real-time risk scoring and threat detection                                   │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════
                              PERFORMANCE INDEXES
═══════════════════════════════════════════════════════════════════════════════════

┌─ KEY INDEXES FOR PERFORMANCE ───────────────────────────────────────────────────┐
│                                                                                   │
│  🔍 USERS TABLE:                                                                 │
│     • idx_users_email (email)                                                   │
│     • idx_users_username (username)                                             │
│     • idx_users_role_active (role, is_active)                                   │
│                                                                                   │
│  🔍 FILE_OPERATIONS TABLE:                                                       │
│     • idx_file_operations_user_id (user_id)                                     │
│     • idx_file_operations_status (status)                                       │
│     • idx_file_operations_type (operation_type, operation_subtype)              │
│     • idx_file_operations_expires_at (expires_at)                               │
│                                                                                   │
│  🔍 SEC_REQUEST_LOG TABLE:                                                       │
│     • idx_sec_request_log_ip_address (ip_address)                               │
│     • idx_sec_request_log_created_at (created_at)                               │
│     • idx_sec_request_log_suspicious (is_suspicious WHERE is_suspicious)        │
│     • idx_sec_request_log_risk_score (risk_score)                               │
│                                                                                   │
│  🔍 SEC_BLOCKLIST TABLE:                                                         │
│     • idx_sec_blocklist_ip_address (ip_address)                                 │
│     • idx_sec_blocklist_active (is_active WHERE is_active)                      │
│                                                                                   │
│  🔍 FILE_METADATA TABLE:                                                         │
│     • idx_file_metadata_hash (file_hash)                                        │
│     • idx_file_metadata_suspicious (is_suspicious WHERE is_suspicious)          │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════
                              IMPLEMENTATION NOTES
═══════════════════════════════════════════════════════════════════════════════════

• PK = Primary Key, FK = Foreign Key, UK = Unique Key
• JSONB fields provide flexible storage for metadata and configuration
• Timestamp fields use TIMESTAMP WITH TIME ZONE for proper timezone handling
• Security-first design with comprehensive logging and monitoring
• File processing pipeline with quarantine and validation system
• Real-time analytics with pre-aggregated statistics for performance
• Feature flag system for gradual rollouts and A/B testing
• Complete audit trail for compliance and debugging

Created by: Himanshu | Version: 2.0.0 | License: MIT
